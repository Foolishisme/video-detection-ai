# 客户端使用说明

## 功能特性

- ✅ **异步非阻塞架构**：视频流采集与显示（主线程）与网络请求（工作线程）完全分离，网络卡顿不会导致视频画面卡顿
- ✅ **事件驱动**：仅当YOLO检测到"Person"且满足冷却时间（默认5秒）时，才触发上传
- ✅ **数据压缩**：上传前将图像Resize至640x640并进行JPEG压缩（Quality=80），将Payload控制在50KB以内
- ✅ **智能报警**：集成报警通知系统，支持控制台、文件、邮件、Webhook等多种通知方式

## 依赖安装

```bash
pip install -r requirements-client.txt
```

主要依赖：
- `opencv-python` - 视频处理
- `ultralytics` - YOLO模型
- `requests` - HTTP客户端
- `pyyaml` - 配置文件解析
- `pydantic` - 数据验证

## 配置文件

编辑 `config.yaml` 配置服务端地址和参数：

```yaml
server:
  host: "localhost"  # 服务端IP地址
  port: 8000         # 服务端端口
  endpoint: "/chat"

cooldown_seconds: 5.0  # 冷却时间（秒）

video:
  # source 可以是：
  # - 数字（如 0, 1）：摄像头索引，0 为默认摄像头
  # - 字符串（如 "test_video.mp4"）：视频文件路径（相对于项目根目录或绝对路径）
  source: 0  # 示例：0（摄像头）或 "test_video.mp4"（视频文件）
  fps: 30
  width: 640
  height: 480
  # 视频文件循环播放（仅对视频文件有效）
  loop_video: true  # 视频播放完毕后是否循环播放
```

## 运行方式

### 方式1：直接运行

```bash
cd client
python app.py
```

### 方式2：作为模块运行

```bash
python -m client.app
```

## 使用说明

1. **启动前准备**：
   - 确保 `core_extracted.py` 文件在项目根目录下
   - 确保已安装所有依赖
   - 确保服务端已启动（如果使用云端分析功能）

2. **运行程序**：
   - 程序会自动连接摄像头（默认索引0）或视频文件
   - 使用YOLO检测画面中是否有人
   - 检测到人且满足冷却时间时，自动发送图像到服务端分析
   - 显示分析结果和报警信息

3. **使用视频文件进行测试**：
   - 将测试视频文件放在项目根目录（或使用绝对路径）
   - 在 `config.yaml` 中设置 `video.source` 为视频文件路径，例如：
     ```yaml
     video:
       source: "test_video.mp4"  # 视频文件路径
       loop_video: true  # 是否循环播放
     ```
   - 运行程序，视频会自动循环播放，方便测试告警功能

4. **操作控制**：
   - 按 `q` 键或 `ESC` 键退出程序

## 架构说明

### 主循环流程

```
1. 读取视频帧（VideoPipeline）
2. YOLO推理检测Person（PersonDetector）
3. 绘制检测框
4. 判断是否发送到服务端（冷却时间检查）
5. 提交任务到网络工作线程（NetworkWorker）
6. 检查并显示服务端分析结果
7. 显示视频画面（OpenCV）
```

### 网络工作线程

- 独立守护线程，不阻塞主循环
- 自动压缩图像（640x640, JPEG质量80）
- 异步发送HTTP请求到服务端
- 通过回调函数返回分析结果

## 注意事项

1. **摄像头权限**：确保系统已授予摄像头访问权限
2. **网络连接**：如果使用云端分析，确保网络连接正常
3. **模型文件**：首次运行会自动下载YOLOv8n模型（约6MB）
4. **性能要求**：建议CPU性能较好的设备，确保30FPS流畅运行

## 故障排查

### 问题1：无法连接摄像头或视频文件
- **摄像头问题**：
  - 检查摄像头是否被其他程序占用
  - 尝试更改 `config.yaml` 中的 `source` 值（0, 1, 2...）
  - 检查摄像头驱动是否正常
- **视频文件问题**：
  - 检查视频文件路径是否正确
  - 确保视频文件格式被 OpenCV 支持（如 .mp4, .avi, .mov 等）
  - 如果使用相对路径，确保文件在项目根目录下

### 问题2：服务端连接失败
- 检查服务端是否已启动
- 检查 `config.yaml` 中的服务端地址和端口是否正确
- 检查防火墙设置

### 问题3：检测不到人
- 调整 `config.yaml` 中的 `thresholds.confidence` 值（降低阈值）
- 确保光线充足，人物清晰可见

